<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="m9HzlxEFMjeLY1dz5g98y0-93U1BVLaGlv_D4c984PI"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>

    
    <title>Fulltext searching with whoosh and Jieba | zo9n</title>

    <meta name="description" content="This is a salted fish coder developed website which mainly records and shares coding notes, random thoughts."/>
    <meta name="keywords" content="tech,jieba,whoosh"/>
    
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Fulltext searching with whoosh and Jieba"/>



    <meta property="og:locale" content="zh-Hans">

    <link href="https://fonts.googlefonts.cn/css?family=Merriweather+Sans" rel="stylesheet">

    
    <link href="https://fonts.googleapis.cn/css2?family=Noto+Serif&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <link rel="stylesheet" href="/static/css/code.css" type="text/css">
    
</head>

<body data-new-gr-c-s-check-loaded="14.991.0">

<nav>
    <div class="site-name nav">
        <span><a href="/">zo9n</a></span>
    </div>
    
    <div class="menu nav">
        <ul class="menu">
            <li><a href="/">Home</a></li>
            <li><a href="/about.html">About</a></li>
            <li><a href="/tags.html">Tags</a></li>
            <li><a href="/links.html">Links</a></li>

        </ul>
    </div>


    
    
    
    
    
    
    <hr>
</nav>



<main>
    
    <div class="article-meta">
        <h1 class="title">Fulltext searching with whoosh and Jieba</h1>
        <div class="article-attrs">
            <span class="author"><a href="/about.html">@zo9n</a></span>
            <span class="date"><time>2021-03-22</time></span>
        </div>
    </div>

    <div class="article-body">
        ## Environment dependencies

```python
pip install django-haystack
pip install jieba
pip install whoosh
```
## Environment configuration
Add this configuration in `settings.py`

```python
INSTALLED_APPS = (
	'haystack',	#register fulltext searching framework
	)

#the configuration of fulltext searching
HAYSTACK_CONNECTIONS = {
	'default': {
		# use the whoosh search engine
		'ENGINE': 'haystack.backends.whoosh_backend.WhooshEngine',
		# Specifies the default path of the index files generated by the index data corresponding to the keyword. When using the custom index file, write the custom file path here.
		'PATH': os.path.join(BASE_DIR,'whoosh_index'), #  the file path of the index files.
		}
}

# Auto generate indexes when add, change and delete data in database tables.
HAYSTACK_SIGNAL_PROCESSOR = 'haystack.signals.RealtimeSignalProcessor'

```

Create `search_indexs.py` in applications which need support searching.
```python
from haystack import indexes
from apps.blog.models import Article


class ArticleIndex(indexes.SearchIndex, indexes.Indexable):
    text = indexes.CharField(document=True, use_template=True)

    def get_model(self):
        return Article

    def index_queryset(self, using=None):
        return self.get_model().objects.filter(status='p')
```

In the `templates` folder of the project, create folder structure like `search/indexes/article/article_text.txt`, where `article` is the lowercased model name.

```python
# Specifies which fields in the table to index
{{ object.title }}	# index Title field
{{ object.body }}	# index Body field
```

Add search route
```python
path('search', include('haystack.urls'), name='search'),

```

Add search form in the template.

```html
<form action="/search" method="get">
            {% csrf_token %}
                <span id="searchAria" tabindex="0" onclick="searching()" onblur="offsearch()">
                    <input type="text" id="searchInput" style="display: none; border: none;" name="q">
                    <input type="submit" value="Search" style="border: none; display: none;" id="submitInput">
                    <a href="javascript:void(0);"  class="navPlugs"><i class="fa fa-search" aria-hidden="true"></i></a>
                </span>
</form>
```
tips: there must be an input tag whose attribute named **name** equals **q** in the form.

The following is the page of search results.

```html
    <div class="jupe main-body">
        <ul class="post-list">
            {% if query and page.object_list %}
                {% for result in page.object_list %}
                    <li class="post-item">
                        <a class="post-title"
                           href="{{ result.object.get_absolute_url }}"
                           title="{{ result.object.title }}">{{ result.object.title | truncatesmart:34 }}</a>
                        <span class="post-time">{{ result.object.create_time | date:"Y.m.d" }}</span>
                    </li>
                {% empty %}
                    <p>Not found</p>
                {% endfor %}

                {% if is_paginated %}{% load_pages %}{% endif %}
            {% else %}
                <h3>Found nothing. Try to search by another keyword</h3>
            {% endif %}

        </ul>
    </div>

```

Build index
```python
python manage.py rebuild_index

```

## Configure Jieba Chinese Search
Because the default engine of whoosh doesn't support Chinese, u need to improve it.

Copy the default engine file `\site-packages\haystack\backends\whoosh_backend.py` to the project folder and rename it to `whoosh_cn_backend`.

Open it and import Jieba Chinese analyzer `from jieba.analyse import ChineseAnalyzer`.

Replace `StemmingAnalyzer` in the file with `ChineseAnalyzer`

Change the file path of search engine to custom path in `settings.py`

`'ENGINE': 'apps.search.whoosh_cn_backend.WhooshEngine'`

Rebuild index `python manage.py rebuild_index`

It supports Chinese search now.
    </div>

    <script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="dns-prefetch" href="//cdn.mathjax.org"/>
    <script src="/static/js/math.js"></script>

</main>

<footer>
    <hr/>
    &copy; 2020-2022 Â· <a href="/about.html">zo9n</a>
    
    
    
</footer>


</body>
</html>